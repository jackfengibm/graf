###
# Setup Script
###
rails new graf
cd graf
git add .
git commit -a -m "Initial Add"
git remote add gerrit ssh://jason.anderson@gerrit.w3.bluemix.net:29418/graf
git push gerrit master:refs/heads/master


rails g scaffold Org git_id:integer name:string date_created:date date_updated:date
rails g scaffold Repo org:references git_id:integer name:string full_name:string fork:boolean date_created:date date_updated:date date_pushed:date
rails g scaffold PullRequest repo:references user:references git_id:integer pr_number:integer body:text title:string state:string date_created:date date_closed:date date_updated:date date_merged:date
rails g scaffold User company:references git_id:integer login:string name:string location:string email:string date_created:date date_updated:date
rails g scaffold Commit repo:references user:references sha:string message:string date_created:date created_at:datetime updated_at:datetime
rails g scaffold Company name:string source:string
rails g scaffold GithubLoad  load_start_time:datetime load_complete_time:datetime initial_load:boolean
rails g scaffold GithubLoadMsg github_load:references msg:string log_level:integer log_date:datetime

###
# Tips
###
Get delta github data: https://coderwall.com/p/hu2n4g

How to delete all database data: rake db:schema:load


###
# MYSQL
###
Get all users in the DB:
SELECT User, Host, Password FROM mysql.user;

CREATE DATABASE graf_db CHARACTER SET utf8 COLLATE utf8_general_ci;
GRANT ALL PRIVILEGES ON graf_db.* TO 'graf_user'@'localhost' IDENTIFIED BY 'time4fun';

Delete all database tables
--------
DROP TABLE companies;
DROP TABLE github_load_msgs;
DROP TABLE github_loads;
DROP TABLE pull_requests;
DROP TABLE repos;
DROP TABLE schema_migrations;
DROP TABLE users;
DROP TABLE orgs;
DROP TABLE commits;
DROP TABLE commits_users;


###
# Deploying to BlueMix
###
# Setup the database

From the app's root directory do a push (see following command) and create an mysql db service.

   cf push --command 'bundle exec rake db:create db:migrate' graf

This command will fail but will setup your database.  Now delete your application using but do NOT delete your orphan database

   cf delete graf

Now do another push and bind to the mysql database you created in the first push:

   cf push graf

Your app should now be up and running.



###
# Upgrading on BlueMix with DB Changes
###
cf delete graf
cf create-service mysql graf-db --plan 200
cf push graf
http://graf.ng.w3.bluemix.net/info
cf delete graf
cf push --command 'bundle exec rake db:create db:migrate' graf
cf delete graf
cf push graf
cf push graf



###
# Old Info
###
cf push --command 'bundle exec rails s'

{
   "mysql-5.5": [
      {
         "name": "graf-db",
         "credentials": {
            "name": "d6e8e1188b2124bc7b67fdefa63b8c980",
            "hostname": "10.0.116.62",
            "host": "10.0.116.62",
            "port": 3307,
            "user": "uJ4LJCgf7xsGT",
            "username": "uJ4LJCgf7xsGT",
            "password": "pZDbbwCIZUacr",
            "uri": "mysql://uJ4LJCgf7xsGT:pZDbbwCIZUacr@10.0.116.62:3307/d6e8e1188b2124bc7b67fdefa63b8c980"
         }
      }
   ]
}

# Prod DB
mysql -h 10.0.116.62 -u uJ4LJCgf7xsGT -P 3307 d6e8e1188b2124bc7b67fdefa63b8c980 -p pZDbbwCIZUacr

Database Info: {"adapter"=>"mysql2", "database"=>"d25e275215552449dbabaff6f680e3740", "username"=>"uFxsEo3M8cv6X", "password"=>"pTgdSMT8iIGXu", "host"=>"10.0.116.121", "port"=>3307}

# Stage DB
graf-db-stage
mysql -h 10.0.116.62 -P 3307 -u uA2DrUi8T2BtH d2d8439399b664d0b8d8bc4340ef481c7 -p pOFN7NXyRv8WH



