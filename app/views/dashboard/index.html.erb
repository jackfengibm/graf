<style type="text/css">
#user_prs_chart { width: 660px; height: 660px; font-size:18px; position:relative; }
#company_prs_chart { width: 660px; height: 660px; font-size:18px; position:relative; }
#user_tbl_ctr { width: 600px; height: 660px; font-size:18px; position:relative; }
#company_tbl_ctr { width: 600px; height: 660px; font-size:18px; position:relative; }
</style>

<script type="text/javascript">

  function makeAsDataTableOnLoad(tableHandleIdStr) {
    $(document).ready( function () {
      makeAsDataTable(tableHandleIdStr)
    } );
  }

  function makeAsDataTable(tableHandleIdStr) {
    $(tableHandleIdStr).dataTable({
      "sScrollY": "350px", "sScrollX": "500px",
      "bPaginate": false,
      "bSort": false,
      "bAutoWidth" : true,
      "bFilter": true
    } );
  }


  function filterUpdate() {
    timeframe = $("#quarter_filter").val()
    year = $("#year_filter").val()
    repo = $("#repo_filter").val()
    state = $("#state_filter").val()
    apiAJAX(timeframe, year, repo, state, 'user_chart', 'json', updatePRsUserChartCallback);
    apiAJAX(timeframe, year, repo, state, 'user_table', 'text', updatePRsUserTableCallback);
    apiAJAX(timeframe, year, repo, state, 'company_chart', 'json', updatePRsCompanyChartCallback);
    apiAJAX(timeframe, year, repo, state, 'company_table', 'text', updatePRsCompanyTableCallback);
    apiAJAX(timeframe, year, repo, state, 'monthly_line_graph', 'json', updateMonthlyLineGraphCallback);
  }

  function apiAJAX(timeframe, year, repo, state, data_request, response_type, callback){
    $.ajax({
        url: "api?timeframe=" + timeframe + "&year=" + year + "&repo=" + repo + "&state=" + state + "&data_request=" + data_request,
        method: 'GET',
        dataType: response_type,
        success: callback
    });
  }

  function updatePRsUserChartCallback(result){
    $("#user_prs_chart").empty();
    options = {
         series: {
            pie: {
                show: true,
                radius: 1,
                label: {
                    show: true,
                    radius: 2/3,
                    formatter: function(label, series){
                        return '<div style="font-size:8pt;text-align:center;padding:2px;color:white;">'+label+'<br/>'+Math.round(series.percent)+'%</div>';
                    },
                    threshold: 0.04
                }       
            }
         },
         legend: {
            labelBoxBorderColor: "none"
         }
    }

    $.plot($("#user_prs_chart"), result.response, options);
  }

  function updatePRsUserTableCallback(result){
    $("#user_tbl_ctr").empty();
    $("#user_tbl_ctr").html(result);
    makeAsDataTable("#user_prs_table")
  }

  function updatePRsCompanyChartCallback(result){
    $("#company_prs_chart").empty();
    options = {
         series: {
            pie: {
                show: true,
                radius: 1,
                label: {
                    show: true,
                    radius: 2/3,
                    formatter: function(label, series){
                        return '<div style="font-size:8pt;text-align:center;padding:2px;color:white;">'+label+'<br/>'+Math.round(series.percent)+'%</div>';
                    },
                    threshold: 0.04
                }       
            }
         },
         legend: {
            labelBoxBorderColor: "none"
         }
    }

    $.plot($("#company_prs_chart"), result.response, options);
  }

  function updatePRsCompanyTableCallback(result){
    $("#company_tbl_ctr").empty();
    $("#company_tbl_ctr").html(result);
    makeAsDataTable("#company_prs_table")
  }

  function updateMonthlyLineGraphCallback(result){
      var options = {
      series: {
        lines: {
          show: true
        },
        points: {
          show: true
        }
      },
      xaxis: {
        //tickDecimals: 0, 
        mode: "time",
        minTickSize: [1, "month"],
        //min: (new Date("2010/01/01")).getTime(),
        //max: (new Date("2014/01/02")).getTime()
      },
      legend: {
        position: "nw"

      },
      yaxis: {
        min: 0
      },
      };
      $.plot($("#placeholder"), result.response, options);
  }

  $(document).ready(function () {
    $("#quarter_filter").change(function () {
      filterUpdate()
    });

    $("#year_filter").change(function () {
      filterUpdate()
    });

    $("#repo_filter").change(function () {
      filterUpdate()
    });

    $("#state_filter").change(function () {
      filterUpdate()
    });


  
  });

</script>

<h1>GitHub Repo Analytics for graPHing</h1>
<hr>

<h2>Filters</h2>
  Quarter: 
  <select id="quarter_filter">
    <option value="" selected>All</option>
    <option value="q1">Q1</option>
    <option value="q2">Q2</option>
    <option value="q3">Q3</option>
    <option value="q4">Q4</option>
  </select>
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  Year: 
  <select id="year_filter">
    <option value="" selected>All</option>
    <option value="2012">2012</option>
    <option value="2013">2013</option>
    <option value="2014">2014</option>
  </select>
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  Repository:
  <%= render 'repo_drop_down' %>
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  State:
  <select id="state_filter">
    <option value="" selected>All</option>
    <option value="open">Open</option>
    <option value="merged">Merged</option>
    <option value="closed">Closed (Not Merged)</option>
  </select>
<br><br>
<hr>


<% @table_handle = "pr_days_elapsed_table" %>
<% @table_data = @avg_days_elapsed %>
<% @label_header = "Company" %>
<% @data_header = "Average Days Elapsed" %>
<% @label_index_name = "name" %>
<% @data_index_name = "avg_days_open" %>  

<%= render 'hash_as_table' %>
<script type="text/javascript">
$("#pr_days_elapsed_table").dataTable({
      "sScrollY": "350px", "sScrollX": "500px",
      "bPaginate": false,
      "bSort": false,
      "bAutoWidth" : true,
      "bFilter": true
    } );
</script>
<table cellpadding="50px"><tr><td>
  <h2>Contributions by User</h2><br>
  <%# For User Statistics %>
  <% @chart_handle = "user_prs_chart" %>
  <% @chart_data = @prs_by_user_pie_str %>
  <%= render 'pie_chart' %>
  <div id="user_prs_chart"></div>
<br><br>
  <% @table_handle = "user_prs_table" %>
  <% @table_data = @prs_by_user %>
  <% @label_header = "User" %>
  <% @data_header = "Contributions" %>
  <% @label_index_name = "login" %>
  <% @data_index_name = "num_prs" %>
  <div id="user_tbl_ctr">
  <%= render 'hash_as_table' %>
  </div>
  <script type="text/javascript">makeAsDataTableOnLoad('#<%= @table_handle %>');</script>

</td><td>
  <h2>Contributions by Company</h2><br>
  <%# For Company Statistics %>
  <% @chart_handle = "company_prs_chart" %>
  <% @chart_data = @prs_by_company_pie_str %>
  <%= render 'pie_chart' %>
  <div id="company_prs_chart"></div>
<br><br>
  <% @table_handle = "company_prs_table" %>
  <% @table_data = @prs_by_company %>
  <% @label_header = "Company" %>
  <% @data_header = "Contributions" %>
  <% @label_index_name = "name" %>
  <% @data_index_name = "num_prs" %>	
  <div id="company_tbl_ctr">
  <%= render 'hash_as_table' %>
  </div>
  <script type="text/javascript">makeAsDataTableOnLoad('#<%= @table_handle %>');</script>


</td></tr></table>

<script type="text/javascript">
$(function() {

   var data =  [  { "label": "Pivotal", "data" : [["1301641200000", 1], ["1304233200000", 1], ["1309503600000", 2], ["1314860400000", 1], ["1322726400000", 2], ["1333263600000", 1], ["1357027200000", 19], ["1359705600000", 57], ["1362124800000", 39], ["1364799600000", 53], ["1367391600000", 79], ["1370070000000", 95], ["1372662000000", 64], ["1375340400000", 99], ["1378018800000", 85], ["1380610800000", 52], ["1383289200000", 32], ["1385884800000", 63], ["1388563200000", 16]] },   { "label": "", "data" : [["1301641200000", 15], ["1304233200000", 18], ["1306911600000", 8], ["1309503600000", 1], ["1312182000000", 3], ["1314860400000", 6], ["1317452400000", 2], ["1320130800000", 2], ["1322726400000", 8], ["1325404800000", 5], ["1328083200000", 6], ["1330588800000", 3], ["1333263600000", 1], ["1335855600000", 2], ["1338534000000", 1], ["1341126000000", 3], ["1343804400000", 2], ["1349074800000", 1], ["1354348800000", 1], ["1357027200000", 15], ["1359705600000", 55], ["1362124800000", 60], ["1364799600000", 29], ["1367391600000", 30], ["1370070000000", 25], ["1372662000000", 25], ["1375340400000", 40], ["1378018800000", 13], ["1380610800000", 30], ["1383289200000", 26], ["1385884800000", 41]] },   { "label": "VMware", "data" : [["1330588800000", 2], ["1357027200000", 1], ["1359705600000", 15], ["1362124800000", 20], ["1364799600000", 3], ["1367391600000", 7], ["1370070000000", 16], ["1372662000000", 9], ["1375340400000", 8], ["1378018800000", 4], ["1380610800000", 4], ["1383289200000", 3], ["1385884800000", 12], ["1388563200000", 2]] },   { "label": "IBM", "data" : [["1375340400000", 3], ["1378018800000", 7], ["1380610800000", 22], ["1383289200000", 18], ["1385884800000", 22], ["1388563200000", 3]] },   { "label": "Innovation Factory", "data" : [["1362124800000", 1], ["1367391600000", 1], ["1370070000000", 1], ["1372662000000", 6], ["1375340400000", 10], ["1378018800000", 5], ["1380610800000", 3], ["1383289200000", 1], ["1385884800000", 5]] } ];

var options = {
      series: {
        lines: {
          show: true
        },
        points: {
          show: true
        }
      },
      legend: {
        position: "nw"

      },
      xaxis: {
        //tickDecimals: 0, 
        mode: "time",
        minTickSize: [1, "month"],
        //min: (new Date("2010/01/01")).getTime(),
        //max: (new Date("2014/01/02")).getTime()
      },
      yaxis: {
        min: 0
      },
      };
    $.plot($("#placeholder"), data, options);

  });

  </script>


  <div id="content">
  <div class="demo-container">
      <div id="placeholder" class="demo-placeholder"></div>
    </div>
  </div>








