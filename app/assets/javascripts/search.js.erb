DATE_PICKER_OPTIONS = {
    showOn: "button",
    buttonImage: "<%= image_path "calendar.png" %>",
    buttonImageOnly: true
  };
  
var autoUpdateOnFilterChange = true;

//
// Search Criteria Box Functions
//
function initializeSearchCriteria(guardedUpdate) {
  // Initialize the Filters
  jQuery.each(FILTERS, function(filterName, filterDetails) {
    $("#" + filterName + "_filter").change(function () {
      guardedUpdate();
    });
  });

  $("#clear_search_criteria_button").click(function () {
    clearSearchCriteria(guardedUpdate);
  });

  //
  // Setup the date pickers
  //
  $(function() {
    $("#start_date_filter").datepicker(DATE_PICKER_OPTIONS);
  });

  $(function() {
    $("#end_date_filter").datepicker(DATE_PICKER_OPTIONS);
  });
}

function sanitizeSearchValue(input) {
  if (input == null) {
    var arr = new Array();
    arr[0] = "";
    return arr;
  }
  else {
    return input;
  }
}

function createSearchCriteriaJSON() {
  values = {};
  filters = METRICS.base_metrics[METRICS.metrics[$("#metric_filter").val()].base_metric].filters;
  $.each(filters, function(index, filterName) {
    values[filterName] = sanitizeSearchValue($("#" + filterName + "_filter").val());
  });

  return values;
}


function clearSearchCriteria(guardedUpdate) {
  // Turn off auto updates on a filter change since we will be clearing all of them
  // in a serialize fashion which would trigger multiple updates.
  autoUpdateOnFilterChange = false;
  
  // Clear all the filters
  // TODO suspend all refreshs and do one at the end
  jQuery.each(FILTERS, function(filterName, filterDetails) {
    if (filterDetails.type == "multiselect") {
      $("#" + filterName + "_filter").multiselect("uncheckAll");
    }
    else if (filterDetails.type == "datepicker") {
      $("#" + filterName + "_filter").val("");
    }
    else {
      alert('Unknown filterType = ' + filterDetails.type);
    }
  });

  // Turn automatice filter updates back on
  autoUpdateOnFilterChange = true;

  // Update chart now that values have been reset
  guardedUpdate();
}