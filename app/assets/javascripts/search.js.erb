DATE_PICKER_OPTIONS = {
    showOn: "button",
    buttonImage: "<%= image_path "calendar.png" %>",
    buttonImageOnly: true
  };

//
// Search Criteria Box Functions
//
function initializeSearchCriteria() {
  // Initialize the Filters
  jQuery.each(FILTERS, function(filterName, filterDetails) {
    $("#" + filterName + "_filter").change(function () {
      filterUpdate();
    });
  });

  $("#metric_filter").change(function () {
    filterUpdate();
  });

  $("#group_by_filter").change(function () {
    filterUpdate();
  });

  $("#clear_search_criteria_button").click(function () {
    clearSearchCriteria();
  });

  //
  // Setup the date pickers
  //
  $(function() {
    $( "#start_date_filter" ).datepicker(DATE_PICKER_OPTIONS);
  });

  $(function() {
    $( "#end_date_filter" ).datepicker(DATE_PICKER_OPTIONS);
  });
}

function loadLocalStorage() {
  // Load and parse local storage
  var values = window.localStorage.getItem('vals');
  values = jQuery.parseJSON(values);
  for (v in values){
    $("#" + toUnderscore(v) + "_filter").val(values[v]);
  }
}

function sanitizeSearchValue(input) {
  if (input == null) {
    var arr = new Array();
    arr[0] = "";
    return arr;
  }
  else {
    return input;
  }
}

function createSearchCriteriaJSON() {
  values = {};
  filters = METRICS.base_metrics[METRICS.metrics[$("#metric_filter").val()].base_metric].filters;
  $.each(filters, function(index, filterName) {
    values[filterName] = sanitizeSearchValue($("#" + filterName + "_filter").val());
  });

  return values;
}


function clearSearchCriteria() {
  
  // Clear all the filters
  // TODO suspend all refreshs and do one at the end
  jQuery.each(FILTERS, function(filterName, filterDetails) {
    if (filterDetails.type == "multiselect") {
      $("#" + filterName + "_filter").multiselect("uncheckAll");
    }
    else if (filterDetails.type == "datepicker") {
      $("#" + filterName + "_filter").val("");
    }
    else {
      alert('Unknown filterType = ' + filterDetails.type);
    }
  });

  // Update chart now that values have been reset
  filterUpdate();
}